-- title:  Orb
-- author: gamerdonkey
-- desc:   You are orb. Don't shoot things
-- script: lua

-- Constants

COLS=30
ROWS=17

M={
	BOOT=0,
	TITLE=1,
	RUN=2,
	CRASH=3,
	HIT=4,
	END=5
}

WTYPE={
	VERT=0,
	HORZ=1
}

-- Game Objects

Game={
	t=0,
	mode=M.BOOT
}

Plyr={
	x=120,
	y=63,
	r=8,
	weapon=WTYPE.VERT,
	score=0
}

target={
	x=200,
	y=100,
	r=8
}

projectiles={}


function handleButtons()
	if btn(0) then Plyr.y=Plyr.y-2 end
	if btn(1) then Plyr.y=Plyr.y+2 end
	if btn(2) then Plyr.x=Plyr.x-2 end
	if btn(3) then Plyr.x=Plyr.x+2 end
	
	if btnp(4) then
        if Plyr.weapon==WTYPE.VERT then
            Plyr.weapon=WTYPE.HORZ
        else
            Plyr.weapon=WTYPE.VERT
        end
	end
end


function updateProjectiles(projectiles)
	for key, projectile in pairs(projectiles) do
		if projectile.type==WTYPE.VERT then
			if projectile.id==1 then
				projectile.y=projectile.y+projectile.speed
			elseif projectile.id==2 then
				projectile.y=projectile.y-projectile.speed
			end
		else
            if projectile.id==1 then
				projectile.x=projectile.x+projectile.speed
			elseif projectile.id==2 then
				projectile.x=projectile.x-projectile.speed
			end
  end
		
		if projectile.x<0 or projectile.x>239
				or projectile.y<0 or projectile.y>135
				then
			table.remove(projectiles,key)
		end
	end
end


function collide(a,b)
	dist=math.pow(a.x-b.x,2)+math.pow(a.y-b.y,2)
	r=math.pow(a.r+b.r,2)
	
	return(dist<=r)
end


function updateTarget(target)
	if target.x<-15 then
		Plyr.score=Plyr.score+50
		target.x=255
		target.y=math.random(136)
	end
	
	target.x=target.x-1
end


function TIC()
	if Game.mode==M.BOOT then
		cls(15)
		print("You Are Orb",90,math.min(63,Game.t/4),12)
			if Game.t>400 then
				Game.mode=M.RUN
			end
	elseif Game.mode==M.RUN then
		handleButtons()
		
		if Game.t%50==0 then
			for i=1,2 do
				p={id=i,type=Plyr.weapon,x=Plyr.x,y=Plyr.y,r=2,speed=4}
				table.insert(projectiles,p)
			end
		end
		
		updateProjectiles(projectiles)
		updateTarget(target)
	
		cls(0)
		circ(target.x,target.y,target.r,9)
		for key, projectile in pairs(projectiles) do
			rect(projectile.x-projectile.r,projectile.y-projectile.r,projectile.r*2,projectile.r*2,5)
			if collide(projectile,target) then
				Game.mode=M.HIT
			end
		end
		circ(Plyr.x,Plyr.y,Plyr.r,2)
		map(0,0,COLS,ROWS,0,0,0)
		print(string.format("%06d",Plyr.score),202,4,4)
	elseif Game.mode==M.HIT then
		print("Don't Shoot Orbs",78,63,12)
		Game.mode=M.END
	end

	Game.t=Game.t+1
end

-- <TILES>
-- 001:8888888888888888888888888888888888888888888888888888888866666666
-- 002:6666666688888888888888888888888888888888888888888888888888888888
-- 003:8888888888888888888888888888888888888888888888888888888888888888
-- 240:000000000c000cc000c0cc00000cc000000cc000000cc000000cc00000000000
-- 241:0000000000cccc000cc00cc00cc00cc00cc00cc00cc00cc000cccc0000000000
-- 242:000000000cc00cc00cc00cc00cc00cc00cc00cc00cc00cc000ccccc000000000
-- 243:0000000000cccc000cc00cc00cc00cc00cccccc00cc00cc00cc00cc000000000
-- 244:000000000ccccc000cc00cc00cc00cc00ccccc000cc00cc00cc00cc000000000
-- 245:000000000cccccc00ccc00000cccccc00ccc00000ccc00000cccccc000000000
-- 246:000000000ccccc000cc00cc00ccccc000cc00cc00cc00cc00ccccc0000000000
-- 247:00000000000cc000000cc000000cc000000cc00000000000000cc00000000000
-- </TILES>

-- <SPRITES>
-- 000:0000002200002222000222220022222202222222022222222222222222222222
-- 001:2200000022220000222220002222220022222220222222202222222222222222
-- 002:0000002200002224000224440022444402244444024444442244444424444444
-- 003:2200000042220000444220004444220044444220444444204444442244444442
-- 016:2222222222222222022222220222222200222222000222220000222200000022
-- 017:2222222222222222222222202222222022222200222220002222000022000000
-- 018:2444444422444444024444440224444400224444000224440000222400000022
-- 019:4444444244444422444444204444422044442200444220004222000022000000
-- </SPRITES>

-- <MAP>
-- 000:001010103030303030303030101010101030303030301010103030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:000000001010103030101010000000000010303030100000001030303010303030303030101010103030301010101030303010101010303030101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:000000000000001010000000000000000000101010000000000010101000101010101010000000001010100000000010101000000000101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:000000000000000000000000000000202000002000000000000000000000000000000020202020202020200020202030202020202020000000002020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:000000000000000000200000002020303020203020000000000000000000002020202030303030303030302030303030303030303030202020203030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:202020202020202020302020203030303030303030202020202020202020203030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 122:0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f1f2f000000000000000000000000000000000000000000
-- 124:0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f4f5f000000000000000000000000000000000000
-- 126:0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f4f6f7f0000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:0209020a021b022c024d024f025f026002710282029302a302a302c402d602e602f702f7f200f200f200f200f200f200f200f200f200f200f200f200420000000000
-- 001:0200020002100220024002400250026002700280029002a002a002c002d002e002f002f0f200f200f200f200f200f200f200f200f200f200f200f200410000000000
-- </SFX>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

